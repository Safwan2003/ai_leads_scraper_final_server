<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Lead Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-900 text-white font-sans">

    <div class="flex h-screen bg-gray-900">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-gray-800 p-6">
            <div class="text-white text-2xl font-bold mb-10">Lead Admin</div>
            <nav>
                <a href="#" class="flex items-center py-2 px-4 text-lg bg-indigo-600 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt mr-3"></i> Dashboard
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <div class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-900 p-8">
                <header class="text-left mb-12">
                    <h1 class="text-4xl font-extrabold text-white">Dashboard</h1>
                    <p class="text-gray-400 mt-2 text-lg">Analytics and Lead Management Overview</p>
                </header>

                <!-- Dashboard Analytics -->
                <div id="dashboard-analytics" class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg col-span-1 lg:col-span-1 flex flex-col justify-center items-center">
                        <h3 class="text-2xl font-bold text-white mb-4">Total Leads</h3>
                        <p id="total-leads-stat" class="text-6xl font-extrabold text-indigo-400">-</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg col-span-1 lg:col-span-2">
                        <h3 class="text-2xl font-bold text-white mb-4">Leads by Qualification</h3>
                        <canvas id="qualificationChart"></canvas>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg col-span-1 lg:col-span-3">
                        <h3 class="text-2xl font-bold text-white mb-4">Leads by Source</h3>
                        <canvas id="sourceChart"></canvas>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-lg shadow-lg p-8">
                    <h2 class="text-3xl font-bold mb-6">Lead Management</h2>

                    <!-- Advanced Filters -->
                    <div class="bg-gray-700 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <input type="text" id="filter-search-term" placeholder="Universal Search..." class="bg-gray-800 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:border-indigo-500">
                            <select id="filter-qualified" class="bg-gray-800 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:border-indigo-500">
                                <option value="">All Qualifications</option>
                                <option value="Hot Lead">Hot Lead</option>
                                <option value="Strong Prospect">Strong Prospect</option>
                                <option value="Good Fit">Good Fit</option>
                                <option value="Potential">Potential</option>
                                <option value="Low Priority">Low Priority</option>
                            </select>
                            <select id="filter-source" class="bg-gray-800 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:border-indigo-500">
                                <option value="">All Sources</option>
                            </select>
                            <input type="number" id="filter-min-score" placeholder="Min Score (0-100)" class="bg-gray-800 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:border-indigo-500">
                            <button id="apply-filters" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg col-span-1 md:col-span-3 lg:col-span-1"><i class="fas fa-filter"></i> Apply Filters</button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <div id="bulk-actions-container" class="hidden">
                            <select id="bulk-action-select" class="bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white">
                                <option value="">Bulk Actions</option>
                                <option value="rescrape">Rescrape Selected</option>
                                <option value="delete">Delete Selected</option>
                                <option value="set_status_New">Set Status: New</option>
                                <option value="set_status_Contacted">Set Status: Contacted</option>
                                <option value="set_status_Closed">Set Status: Closed</option>
                            </select>
                            <button id="apply-bulk-action" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg ml-2">Apply</button>
                        </div>
                        <select id="sort-by" class="bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:border-indigo-500 ml-auto">
                            <option value="last_updated">Sort by Date</option>
                            <option value="lead_score">Sort by Score</option>
                            <option value="company_name">Sort by Name</option>
                        </select>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-gray-800">
                            <thead>
                                <tr class="bg-gray-700 text-indigo-300 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left"><input type="checkbox" id="select-all-leads"></th>
                                    <th class="py-3 px-6 text-left">ID</th>
                                    <th class="py-3 px-6 text-left">Company Name</th>
                                    <th class="py-3 px-6 text-left">Website</th>
                                    <th class="py-3 px-6 text-left">Qualified</th>
                                    <th class="py-3 px-6 text-left">Score</th>
                                    <th class="py-3 px-6 text-left">Status</th>
                                    <th class="py-3 px-6 text-left">Source</th>
                                    <th class="py-3 px-6 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leads-table-body" class="text-gray-300 text-sm font-light">
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-between items-center mt-6">
                        <button id="prev-page" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-arrow-left"></i> Previous</button>
                        <span id="page-info" class="text-gray-400 text-sm"></span>
                        <button id="next-page" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Next <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden">
        <p id="toast-message"></p>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        const leadsTableBody = document.getElementById('leads-table-body');
        const totalLeadsStat = document.getElementById('total-leads-stat');
        const applyFiltersButton = document.getElementById('apply-filters');
        const filterSearchTerm = document.getElementById('filter-search-term');
        const filterQualified = document.getElementById('filter-qualified');
        const filterSource = document.getElementById('filter-source');
        const filterMinScore = document.getElementById('filter-min-score');
        const sortBy = document.getElementById('sort-by');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');
        const selectAllCheckbox = document.getElementById('select-all-leads');
        const bulkActionsContainer = document.getElementById('bulk-actions-container');
        const applyBulkActionButton = document.getElementById('apply-bulk-action');
        const bulkActionSelect = document.getElementById('bulk-action-select');

        let currentPage = 1;
        const limit = 10;
        let qualificationChart = null;
        let sourceChart = null;
        let selectedLeadIds = new Set();

        const escapeHTML = (str) => {
            if (!str) return '';
            return String(str).replace(/[&<>"'`]/g, match => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;',
                '`': '&#96;'
            }[match]));
        };

        const getStatusClass = status => {
            switch (status) {
                case 'New': return 'bg-blue-500 text-white';
                case 'Contacted': return 'bg-yellow-500 text-black';
                case 'In Progress': return 'bg-purple-500 text-white';
                case 'Closed': return 'bg-green-500 text-white';
                case 'Rejected': return 'bg-red-500 text-white';
                default: return 'bg-gray-500 text-white';
            }
        };

        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        };

        const renderCharts = stats => {
            totalLeadsStat.textContent = stats.total_leads;
            const qualCtx = document.getElementById('qualificationChart').getContext('2d');
            const sourceCtx = document.getElementById('sourceChart').getContext('2d');

            if (qualificationChart) qualificationChart.destroy();
            qualificationChart = new Chart(qualCtx, {
                type: 'doughnut',
                data: { labels: Object.keys(stats.leads_by_qualification), datasets: [{ data: Object.values(stats.leads_by_qualification), backgroundColor: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#6B7280'] }] },
                options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#D1D5DB' } } } }
            });

            if (sourceChart) sourceChart.destroy();
            sourceChart = new Chart(sourceCtx, {
                type: 'bar',
                data: { labels: Object.keys(stats.leads_by_source), datasets: [{ label: 'Leads', data: Object.values(stats.leads_by_source), backgroundColor: '#4F46E5' }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } }, x: { ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } } } }
            });

            filterSource.innerHTML = '<option value="">All Sources</option>';
            Object.keys(stats.leads_by_source).forEach(source => {
                const option = document.createElement('option');
                option.value = source;
                option.textContent = source;
                filterSource.appendChild(option);
            });
        };

        const fetchStats = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/stats`);
                if (!response.ok) throw new Error('Failed to load stats');
                const stats = await response.json();
                renderCharts(stats);
            } catch (error) {
                console.error("Error fetching stats:", error);
                document.getElementById('dashboard-analytics').innerHTML = '<p class="text-red-400 col-span-3">Could not load analytics data.</p>';
            }
        };

        const fetchLeads = async () => {
            const url = new URL(`${API_BASE_URL}/admin/leads`);
            url.searchParams.append('page', currentPage);
            url.searchParams.append('limit', limit);
            url.searchParams.append('sort_by', sortBy.value);
            if (filterSearchTerm.value) url.searchParams.append('search_term', filterSearchTerm.value);
            if (filterQualified.value) url.searchParams.append('qualified', filterQualified.value);
            if (filterSource.value) url.searchParams.append('source', filterSource.value);
            if (filterMinScore.value) url.searchParams.append('min_score', filterMinScore.value);

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                renderLeads(data.leads);
                renderPagination(data.total);
            } catch (error) {
                console.error("Error fetching leads:", error);
                leadsTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4">Error loading leads.</td></tr>`;
            }
        };

        const renderLeads = leads => {
            leadsTableBody.innerHTML = '';
            if (leads.length === 0) {
                leadsTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4">No leads found.</td></tr>`;
                return;
            }
            leads.forEach(lead => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-700', 'hover:bg-gray-700');
                const status = lead.status || 'New';
                row.innerHTML = `
                    <td class="py-3 px-6"><input type="checkbox" class="lead-checkbox bg-gray-700 border-gray-600" data-id="${lead.id}"></td>
                    <td class="py-3 px-6">${lead.id}</td>
                    <td class="py-3 px-6">${lead.company_name}</td>
                    <td class="py-3 px-6"><a href="${lead.website}" target="_blank" class="text-indigo-400 hover:underline">${lead.website}</a></td>
                    <td class="py-3 px-6">${lead.qualified}</td>
                    <td class="py-3 px-6">${lead.lead_score}</td>
                    <td class="py-3 px-6"><span class="px-2 py-1 font-semibold text-xs rounded-full ${getStatusClass(status)}">${status}</span></td>
                    <td class="py-3 px-6">${lead.source}</td>
                    <td class="py-3 px-6">
                        <button class="edit-btn text-blue-400 hover:text-blue-300" data-id="${lead.id}" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn text-red-400 hover:text-red-300 ml-4" data-id="${lead.id}" title="Delete"><i class="fas fa-trash-alt"></i></button>
                        <button class="rescrape-btn text-green-400 hover:text-green-300 ml-4" data-id="${lead.id}" title="Rescrape"><i class="fas fa-sync-alt"></i></button>
                    </td>
                `;
                leadsTableBody.appendChild(row);
            });
            updateCheckboxes();
        };

        const renderPagination = total => {
            const totalPages = Math.ceil(total / limit);
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = currentPage >= totalPages;
        };

        const updateBulkActionsVisibility = () => {
            bulkActionsContainer.classList.toggle('hidden', selectedLeadIds.size === 0);
        };

        const updateCheckboxes = () => {
            document.querySelectorAll('.lead-checkbox').forEach(checkbox => {
                checkbox.checked = selectedLeadIds.has(parseInt(checkbox.dataset.id));
            });
            const allCheckboxes = document.querySelectorAll('.lead-checkbox');
            selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === document.querySelectorAll('.lead-checkbox:checked').length;
        };

        leadsTableBody.addEventListener('click', e => {
            if (e.target.classList.contains('lead-checkbox')) {
                const leadId = parseInt(e.target.dataset.id);
                if (e.target.checked) selectedLeadIds.add(leadId); else selectedLeadIds.delete(leadId);
                updateBulkActionsVisibility();
                updateCheckboxes();
                return;
            }
            const button = e.target.closest('button');
            if (!button) return;
            const leadId = button.dataset.id;
            if (button.classList.contains('edit-btn')) openEditModal(leadId);
            if (button.classList.contains('delete-btn')) {
                Swal.fire({ title: 'Are you sure?', text: "You won't be able to revert this!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Yes, delete it!', background: '#1F2937', color: '#ffffff' }).then(result => {
                    if (result.isConfirmed) deleteLead(leadId);
                });
            }
            if (button.classList.contains('rescrape-btn')) rescrapeLead(leadId);
        });

        selectAllCheckbox.addEventListener('change', e => {
            document.querySelectorAll('.lead-checkbox').forEach(checkbox => {
                const leadId = parseInt(checkbox.dataset.id);
                checkbox.checked = e.target.checked;
                if (e.target.checked) selectedLeadIds.add(leadId); else selectedLeadIds.delete(leadId);
            });
            updateBulkActionsVisibility();
        });

        const applyBulkAction = async () => {
            const action = bulkActionSelect.value;
            if (!action || selectedLeadIds.size === 0) return;
            const lead_ids = Array.from(selectedLeadIds);
            let payload = { lead_ids, action, value: action.startsWith('set_status') ? action.replace('set_status_', '') : null };
            try {
                const response = await fetch(`${API_BASE_URL}/admin/bulk-actions/leads`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error((await response.json()).detail || 'Failed to apply bulk action');
                showToast('Bulk action applied successfully!');
                selectedLeadIds.clear();
                fetchLeads();
                fetchStats();
                updateBulkActionsVisibility();
            } catch (error) { showToast(error.message, true); }
        };

        applyBulkActionButton.addEventListener('click', applyBulkAction);

        const openEditModal = async (leadId) => {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/leads/${leadId}`);
                if (!response.ok) throw new Error('Failed to load lead data');
                const lead = await response.json();
                const { value: formValues } = await Swal.fire({
                    title: 'Edit Lead',
                    html: `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                            <div><label class="block text-gray-300 text-sm font-bold mb-1">Company</label><input id="swal-company-name" class="swal2-input bg-gray-700" value="${lead.company_name || ''}"></div>
                            <div><label class="block text-gray-300 text-sm font-bold mb-1">Website</label><input id="swal-website" class="swal2-input bg-gray-700" value="${lead.website || ''}"></div>
                            <div><label class="block text-gray-300 text-sm font-bold mb-1">Status</label><select id="swal-status" class="swal2-input bg-gray-700"><option value="New" ${lead.status === 'New' ? 'selected' : ''}>New</option><option value="Contacted" ${lead.status === 'Contacted' ? 'selected' : ''}>Contacted</option><option value="In Progress" ${lead.status === 'In Progress' ? 'selected' : ''}>In Progress</option><option value="Closed" ${lead.status === 'Closed' ? 'selected' : ''}>Closed</option><option value="Rejected" ${lead.status === 'Rejected' ? 'selected' : ''}>Rejected</option></select></div>
                            <div><label class="block text-gray-300 text-sm font-bold mb-1">Score</label><input id="swal-lead-score" type="number" class="swal2-input bg-gray-700" value="${lead.lead_score || 0}"></div>
                            <div class="md:col-span-2"><label class="block text-gray-300 text-sm font-bold mb-1">Email</label><input id="swal-email" class="swal2-input bg-gray-700" value="${Array.isArray(lead.email) ? lead.email.join(', ') : (lead.email || '')}"></div>
                            <div class="md:col-span-2"><label class="block text-gray-300 text-sm font-bold mb-1">Contact No</label><input id="swal-contact-no" class="swal2-input bg-gray-700" value="${Array.isArray(lead.contact_no) ? lead.contact_no.join(', ') : (lead.contact_no || '')}"></div>
                            <div class="md:col-span-2"><label class="block text-gray-300 text-sm font-bold mb-1">Reasoning</label><textarea id="swal-reasoning" class="swal2-textarea bg-gray-700 text-white" readonly></textarea></div>
                            <div class="md:col-span-2"><label class="block text-gray-300 text-sm font-bold mb-1">Signals</label><textarea id="swal-signals" class="swal2-textarea bg-gray-700 text-white" readonly></textarea></div>
                            <div class="md:col-span-2"><label class="block text-gray-300 text-sm font-bold mb-1">Red Flags</label><textarea id="swal-red-flags" class="swal2-textarea bg-gray-700 text-white" readonly></textarea></div>
                        </div>
                    `,
                    focusConfirm: false, showCancelButton: true, confirmButtonText: 'Save Changes', background: '#1F2937', color: '#ffffff',
                    customClass: { confirmButton: 'bg-indigo-600 hover:bg-indigo-700' },
                    didOpen: (modalElement) => {
                        modalElement.querySelector('#swal-reasoning').value = lead.reasoning || '';
                        modalElement.querySelector('#swal-signals').value = Array.isArray(lead.signals) ? lead.signals.join(', ') : '';
                        modalElement.querySelector('#swal-red-flags').value = Array.isArray(lead.red_flags) ? lead.red_flags.join(', ') : '';
                    },
                    preConfirm: () => ({
                        company_name: document.getElementById('swal-company-name').value,
                        website: document.getElementById('swal-website').value,
                        qualified: lead.qualified,
                        lead_score: parseInt(document.getElementById('swal-lead-score').value, 10),
                        email: document.getElementById('swal-email').value.split(',').map(s => s.trim()).filter(s => s),
                        contact_no: document.getElementById('swal-contact-no').value.split(',').map(s => s.trim()).filter(s => s),
                        industry: lead.industry,
                        location: lead.location,
                        status: document.getElementById('swal-status').value
                    })
                });
                if (formValues) await updateLeadInDb(leadId, formValues);
            } catch (error) { showToast(error.message, true); }
        };

        const updateLeadInDb = async (leadId, updatedLead) => {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/leads/${leadId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedLead) });
                if (!response.ok) throw new Error('Failed to update lead');
                fetchLeads();
                showToast('Lead updated successfully!');
            } catch (error) { showToast(error.message, true); }
        };

        const deleteLead = async (leadId) => {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/leads/${leadId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete lead');
                fetchLeads();
                showToast('Lead deleted successfully!');
            } catch (error) { showToast(error.message, true); }
        };

        const rescrapeLead = async (leadId) => {
            try {
                showToast('Starting rescrape job...');
                const startResponse = await fetch(`${API_BASE_URL}/rescrape/${leadId}`, { method: 'POST' });
                if (!startResponse.ok) throw new Error('Failed to start rescraping job');
                const data = await startResponse.json();
                const jobId = data.job_id;
                showToast(`Rescrape job started: ${jobId}. Polling for completion...`);
                const pollInterval = setInterval(async () => {
                    const statusResponse = await fetch(`${API_BASE_URL}/status/${jobId}`);
                    if (!statusResponse.ok) return;
                    const statusData = await statusResponse.json();
                    if (statusData.status === 'completed') {
                        clearInterval(pollInterval);
                        showToast('Rescrape job completed successfully! Refreshing data...');
                        fetchLeads();
                        fetchStats();
                    } else if (statusData.status === 'failed') {
                        clearInterval(pollInterval);
                        showToast(`Rescrape job ${jobId} failed.`, true);
                    }
                }, 2000);
            } catch (error) { showToast(error.message, true); }
        };

        applyFiltersButton.addEventListener('click', () => { currentPage = 1; fetchLeads(); });
        sortBy.addEventListener('change', () => { currentPage = 1; fetchLeads(); });
        prevPageButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; fetchLeads(); } });
        nextPageButton.addEventListener('click', () => { currentPage++; fetchLeads(); });

        document.addEventListener('DOMContentLoaded', () => {
            fetchStats();
            fetchLeads();
        });
    </script>
</body>
</html>